# Постановка задачи

После получения кейса, были выбраны несколько способов решения кейса:
1. Использовать только yolov5n, для поиска знаков и классификации
2. Обучить yolov5n на знаках всех стран, а потом дотюнить на русские знаки
3. Обучить yolov5n на поиск любых знаков + классифицировать знак отдельной сеткой 

# Датасеты

Для решения задачи искали разнообразные датасеты, со всех стран.
Были найдены следующие датасеты: 
1. https://cg.cs.tsinghua.edu.cn/traffic-sign/ - большой датасет с китайскими знаками 
2. https://sid.erda.dk/public/archives/ff17dc924eba88d5d01a807357d6614c/published-archive.html - маленький датасет с немецкими знаками 

Датасеты с русскими знаками :

3. https://www.kaggle.com/datasets/watchman/rtsd-dataset
4. https://graphics.cs.msu.ru/projects/traffic-sign-recognition.html


Решили остановиться на датасете с русскими знаками с kaggle (3). Данный датасет содержит  198 классов различных знаков. Недостаток данного датасета в том, что самого популярного класса в 2 раза больше чем второго по популярности, а некоторые классы представлены одним изображением. Похожие между собой классы, было решено объеденить в один класс (например ограничение скорости 40,60). В итоге получилось 156 классов.

# Эксперименты

## Проверка гипотезы 1

Для начала попробовали обучить yolov5n на всем датасете (156 классов), без очистки данных. [Логи эксперимента](https://app.clear.ml/projects/e592016f8f08489bb65538d880061378/experiments/f5c71aa76f8e40a99eafbc85d9470f5e/output/execution). Метрики получились плохие, при визуальном просмотре все было тоже плохо, знаки не находились. Конфиг: "yolov5n_config/signs1.yaml".

## Проверка гипотезы 2
Было решено исключить из датасета все классы, количество изображений которых в train было <90 или <60 в тесте. В результате осталось 33 класса. 

Была так же как и в предыдущем эксперименте обучена yolov5n, но метрики опять оказались плохие, результат не поменялся. (Логи не сохранились). Конфиг: "yolov5n_config/signs2.yaml".

## Проверка гипотезы 3

В итоге решили оставить только один класс "Знак" для yolov5n и обучить отдельный классификатор. [Логи эксперимента](https://app.clear.ml/projects/e592016f8f08489bb65538d880061378/experiments/4d3683eb898c4b549bc5e516a7e3b60f/output/execution). Теперь знаки стали находиться хорошо. Конфиг: "yolov5n_config/signs3.yaml".

Эксперименты и обучение классификатора смотрите в соответствующем репозитории.

# Улучшения

Для лучшего распознавания и оптимизации был добавлен трекер [sort](https://github.com/abewley/sort).

Обрабатываются не все кадры, изначально определяется FPS видео, и после этого высчитывается пропуск кадров, чтобы конечное видео было в 5 FPS.

Для улучшения классификации, к найденному bbox добавляется небольшой margin, и такое изображение подается на классификацию.

Неудачно: Попробовали добавить padding для приведения изначального видео к квадратному, но это сделало только хуже.


# Интерфейс

В роли конечного интерфейса, была выбрана библиотека gradio. В данной задаче её достаточно, т.к. при постановке задачи ориентация была на то, что данное решение будет ориентировано на одного пользователя. 

Изначально попробовали сделать realtime обработку с визуализацией прямо в gradio, но данный фреймворк оказался не подходящим для этих целей.

После, сделали визуализацию ограничивающими прямоугольниками, но она получилась рваная, т.к. преобразовывали видео к 5 FPS. 

В результате было решено добавлять сверху к изначальному видео, белую полоску, на которой будут высвечиваться знаки, которые находятся перед водителем. На этом варианте и остановились.

После загрузки видео в интерфейс, начинается обработка, после обработки, справа появляется видео с результатом обработки.

Заки для визуализации были взяты с сайта [rusdorznak.ru](rusdorznak.ru), находятся в папке "Signs".
